<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Couvertures pour Aldo</title>
    <meta name="description" content="Application pour déterminer la couverture adaptée à votre cheval selon la température">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Netflix+Sans:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --netflix-red: #E50914;
            --netflix-red-dark: #B20710;
            --netflix-black: #141414;
            --netflix-dark-gray: #2D2D2D;
            --netflix-gray: #404040;
            --netflix-light-gray: #8C8C8C;
            --netflix-white: #FFFFFF;
            --netflix-gradient: linear-gradient(135deg, #E50914 0%, #B20710 100%);
            --netflix-gradient-dark: linear-gradient(135deg, #141414 0%, #2D2D2D 100%);
            --netflix-gradient-card: linear-gradient(135deg, #1A1A1A 0%, #2D2D2D 100%);
            --shadow-netflix: 0 8px 30px rgba(0, 0, 0, 0.6);
            --shadow-netflix-sm: 0 4px 20px rgba(0, 0, 0, 0.4);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --weather-blue: #00A8FF;
            --weather-blue-dark: #0097E6;
        }

        /* Reset et styles de base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Netflix Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--netflix-black);
            color: var(--netflix-white);
            line-height: 1.4;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* En-tête style Netflix - Mobile First */
        header {
            background: var(--netflix-gradient-dark);
            color: var(--netflix-white);
            padding: 1.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            border-bottom: 3px solid var(--netflix-red);
            box-shadow: var(--shadow-netflix);
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--netflix-gradient);
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: -0.5px;
            flex-wrap: wrap;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.8rem;
            font-weight: 400;
            color: var(--netflix-light-gray);
            padding: 0 10px;
        }

        .settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(229, 9, 20, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
            box-shadow: var(--shadow-netflix-sm);
            z-index: 100;
        }

        .settings-btn:hover,
        .settings-btn:focus {
            background: var(--netflix-red);
            transform: rotate(90deg) scale(1.1);
            outline: none;
            box-shadow: 0 6px 25px rgba(229, 9, 20, 0.5);
        }

        /* Section principale - Layout mobile */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: stretch;
        }

        /* Section de saisie style carte Netflix */
        .input-section {
            background: var(--netflix-gradient-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-netflix);
            transition: var(--transition);
            border: 1px solid var(--netflix-gray);
            position: relative;
            overflow: hidden;
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--netflix-gradient);
        }

        .input-section:active {
            transform: scale(0.98);
        }

        .form-group {
            margin-bottom: 2rem;
        }

        label {
            display: block;
            margin-bottom: 1rem;
            font-weight: 700;
            color: var(--netflix-white);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--netflix-red);
            z-index: 1;
            font-size: 1.2rem;
        }

        input[type="number"], 
        input[type="text"],
        select {
            width: 100%;
            padding: 18px 18px 18px 50px;
            border: 2px solid var(--netflix-gray);
            border-radius: 8px;
            font-size: 1.1rem;
            background: var(--netflix-dark-gray);
            color: var(--netflix-white);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: var(--transition);
            font-weight: 500;
            font-family: 'Netflix Sans', sans-serif;
            min-height: 60px;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23E50914' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 12px;
            padding-right: 50px;
        }

        /* Amélioration pour mobile - taille de touche minimale */
        input[type="number"]:focus, 
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--netflix-red);
            background: var(--netflix-black);
            box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.3);
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Section Météo Améliorée */
        .meteo-section.enhanced {
            background: rgba(0, 168, 255, 0.1);
            border: 2px solid rgba(0, 168, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 2rem 0;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .meteo-section.enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, var(--weather-blue) 0%, var(--weather-blue-dark) 100%);
        }

        .meteo-section.enhanced:active {
            transform: scale(0.98);
        }

        .meteo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .meteo-header span {
            font-weight: 700;
            color: var(--weather-blue);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .location-badge {
            background: rgba(0, 168, 255, 0.2);
            border: 2px solid rgba(0, 168, 255, 0.4);
            color: var(--weather-blue);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
        }

        .location-badge:active {
            transform: scale(0.95);
        }

        .weather-widget {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .current-weather {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .temp-display {
            text-align: center;
        }

        .temp-display span {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--weather-blue), #00D2D3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: block;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .temp-display small {
            color: var(--netflix-light-gray);
            font-size: 1rem;
            font-weight: 500;
        }

        .weather-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 168, 255, 0.3);
            border-top: 4px solid var(--weather-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .weather-error {
            text-align: center;
            padding: 2rem;
            color: var(--netflix-light-gray);
        }

        .weather-error i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--netflix-red);
        }

        .weather-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .weather-actions .btn {
            flex: 1;
            min-width: 140px;
        }

        /* Boutons style Netflix - Taille mobile optimale */
        .btn {
            background: var(--netflix-gradient);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
            box-shadow: var(--shadow-netflix-sm);
            min-height: 60px;
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-family: 'Netflix Sans', sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:hover,
        .btn:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.4);
            outline: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: var(--shadow-netflix-sm) !important;
        }

        .btn-meteo {
            background: linear-gradient(135deg, var(--weather-blue) 0%, var(--weather-blue-dark) 100%);
        }

        .btn-meteo:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(0, 168, 255, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--netflix-red);
            color: var(--netflix-red);
        }

        .btn-outline:hover:not(:disabled),
        .btn-outline:focus:not(:disabled) {
            background: var(--netflix-red);
            color: white;
            transform: translateY(-2px);
        }

        .btn-settings {
            background: linear-gradient(135deg, #8E44AD 0%, #9B59B6 100%);
        }

        /* Radio groups améliorés */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 1rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 16px;
            border: 2px solid var(--netflix-gray);
            border-radius: 8px;
            background: var(--netflix-dark-gray);
            font-size: 1rem;
            transition: var(--transition);
            font-weight: 500;
            min-height: 60px;
        }

        .radio-option:active {
            transform: scale(0.98);
        }

        .radio-option input {
            margin-right: 12px;
            transform: scale(1.3);
            accent-color: var(--netflix-red);
        }

        .radio-option.selected {
            border-color: var(--netflix-red);
            background: rgba(229, 9, 20, 0.1);
            box-shadow: 0 8px 25px rgba(229, 9, 20, 0.2);
        }

        /* Chips de villes */
        .city-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 1rem;
        }

        .city-chip {
            background: rgba(0, 168, 255, 0.1);
            border: 2px solid rgba(0, 168, 255, 0.3);
            color: var(--weather-blue);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Netflix Sans', sans-serif;
        }

        .city-chip:hover {
            background: rgba(0, 168, 255, 0.2);
            transform: translateY(-2px);
        }

        .city-chip:active {
            transform: scale(0.95);
        }

        /* Section Historique style Netflix */
        .history-section {
            background: var(--netflix-gradient-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-netflix);
            transition: var(--transition);
            border: 1px solid var(--netflix-gray);
            position: relative;
            overflow: hidden;
        }

        .history-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(135deg, #8E44AD 0%, #9B59B6 100%);
        }

        .history-section:active {
            transform: scale(0.98);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .history-title {
            font-weight: 900;
            color: var(--netflix-white);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .history-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--netflix-gray);
            color: var(--netflix-white);
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: var(--transition);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            -webkit-user-select: none;
            user-select: none;
        }

        .history-btn:active {
            transform: scale(0.9);
        }

        .history-btn:hover {
            background: var(--netflix-red);
            color: white;
            transform: scale(1.05);
            border-color: var(--netflix-red);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--netflix-red) var(--netflix-dark-gray);
            -webkit-overflow-scrolling: touch;
        }

        .history-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-list::-webkit-scrollbar-track {
            background: var(--netflix-dark-gray);
            border-radius: 4px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--netflix-red);
            border-radius: 4px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--netflix-gray);
            transition: var(--transition);
            border-radius: 6px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            min-height: 70px;
        }

        .history-item:active {
            transform: scale(0.98);
        }

        .history-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .history-date {
            font-weight: 700;
            color: var(--netflix-red);
            min-width: 80px;
            font-size: 0.9rem;
        }

        .history-temp {
            font-size: 1.4rem;
            font-weight: 900;
            min-width: 60px;
            text-align: center;
            background: linear-gradient(135deg, #E50914, #00A8FF, #8E44AD);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .history-rec {
            flex-grow: 1;
            margin: 0 1rem;
            font-weight: 600;
            font-size: 1rem;
        }

        .history-delete {
            background: rgba(229, 9, 20, 0.1);
            border: 2px solid rgba(229, 9, 20, 0.3);
            color: var(--netflix-red);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
        }

        .history-delete:active {
            transform: scale(0.9);
        }

        .history-delete:hover {
            background: var(--netflix-red);
            color: white;
            transform: scale(1.05);
            border-color: var(--netflix-red);
        }

        .empty-history {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--netflix-light-gray);
        }

        .empty-history i {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
            background: linear-gradient(135deg, #E50914, #8E44AD);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Modales style Netflix - Optimisées mobile */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--netflix-gradient-card);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-netflix);
            transform: translateY(30px) scale(0.95);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            border: 1px solid var(--netflix-gray);
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            padding: 1.5rem;
            background: var(--netflix-gradient);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            min-height: 80px;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--netflix-gradient);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-wrap: wrap;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            flex-shrink: 0;
            -webkit-user-select: none;
            user-select: none;
        }

        .close-modal:active {
            transform: scale(0.9);
        }

        .close-modal:hover,
        .close-modal:focus {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg) scale(1.05);
            outline: none;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Formulaire de paramètres */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .settings-label {
            font-weight: 700;
            color: var(--netflix-white);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Affichage des résultats - Optimisé mobile */
        .temperature-display {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #E50914, #00A8FF, #8E44AD, #00D2D3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: netflixPulse 2s infinite;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes netflixPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .recommendation {
            font-size: 1.6rem;
            margin-bottom: 1.5rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-wrap: wrap;
        }

        .details {
            color: var(--netflix-light-gray);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.5;
            text-align: center;
            padding: 0 10px;
        }

        .info {
            color: var(--netflix-white);
            font-weight: 600;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: inline-block;
            font-size: 1rem;
            border: 1px solid var(--netflix-gray);
            text-align: center;
            margin: 0 auto;
            display: block;
            width: fit-content;
            max-width: 100%;
        }

        /* Guide - Optimisé mobile */
        .guide-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: left;
        }

        .guide-card {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-netflix);
            transition: var(--transition);
            background: var(--netflix-gradient-card);
            border: 1px solid var(--netflix-gray);
        }

        .guide-card:active {
            transform: scale(0.98);
        }

        .guide-header {
            background: var(--netflix-gradient);
            color: white;
            padding: 1.5rem;
            font-weight: 900;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-height: 80px;
        }

        .guide-body {
            padding: 1.5rem;
        }

        .temperature-range {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--netflix-gray);
            transition: var(--transition);
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .temperature-range:active {
            transform: scale(0.98);
        }

        .temperature-range:last-child {
            border-bottom: none;
        }

        .range {
            font-weight: 700;
            color: var(--netflix-red);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            min-width: 140px;
        }

        .recommendation-text {
            color: var(--netflix-white);
            font-weight: 600;
            font-size: 1rem;
            text-align: right;
            flex: 1;
            min-width: 150px;
        }

        /* Classes de couleur pour les recommandations */
        .no-blanket { 
            color: #00D2D3;
            font-weight: 900;
        }
        .light-blanket { 
            color: #00A8FF;
            font-weight: 700;
        }
        .medium-blanket { 
            color: #8E44AD;
            font-weight: 700;
        }
        .heavy-blanket { 
            color: #E50914;
            font-weight: 700;
        }

        /* Indicateur d'état de tonte */
        .tonte-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }

        .tonte-indicator.tondu {
            background: rgba(0, 210, 211, 0.2);
            color: #00D2D3;
        }

        .tonte-indicator.non-tondu {
            background: rgba(142, 68, 173, 0.2);
            color: #8E44AD;
        }

        /* Message d'erreur */
        .error-message {
            color: var(--netflix-red);
            font-size: 1rem;
            margin-top: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        /* Pied de page */
        footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--netflix-light-gray);
            font-size: 1rem;
            margin-top: 3rem;
            border-top: 1px solid var(--netflix-gray);
        }

        /* Styles pour la sélection de ville */
        .city-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .city-card {
            background: var(--netflix-gradient-card);
            border: 2px solid var(--netflix-gray);
            border-radius: var(--border-radius);
            padding: 1.5rem 1rem;
            color: var(--netflix-white);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-height: 100px;
            font-family: 'Netflix Sans', sans-serif;
        }

        .city-card:hover {
            border-color: var(--netflix-red);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(229, 9, 20, 0.3);
        }

        .city-card:active {
            transform: scale(0.95);
        }

        .city-card i {
            font-size: 1.5rem;
            color: var(--netflix-red);
        }

        .city-card span {
            font-size: 0.9rem;
            text-align: center;
        }

        /* Lien Météo France discret */
        .meteo-france-link {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .meteo-france-link a {
            color: var(--netflix-light-gray);
            font-size: 0.8rem;
            text-decoration: none;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            opacity: 0.7;
        }

        .meteo-france-link a:hover {
            color: var(--weather-blue);
            opacity: 1;
            transform: translateY(-1px);
        }

        .meteo-france-link a i {
            font-size: 0.7rem;
        }

        /* Style pour le sélecteur de villes */
        .city-select-container {
            position: relative;
        }

        .city-select-container i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--netflix-red);
            z-index: 1;
            font-size: 1.2rem;
        }

        .city-select-container select {
            padding-left: 50px;
        }

        /* ===== NOUVEAUX STYLES POUR LA GESTION DES COUVERTURES ===== */
        
        /* Styles pour la gestion personnalisée des couvertures */
        .blanket-management {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--netflix-gray);
        }
        
        .blanket-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .blanket-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--netflix-dark-gray);
            border: 2px solid var(--netflix-gray);
            border-radius: 8px;
            transition: var(--transition);
        }
        
        .blanket-item:hover {
            border-color: var(--netflix-red);
            transform: translateX(5px);
        }
        
        .blanket-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .blanket-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .blanket-details {
            flex: 1;
        }
        
        .blanket-name {
            font-weight: 700;
            color: var(--netflix-white);
            font-size: 1rem;
        }
        
        .blanket-specs {
            font-size: 0.85rem;
            color: var(--netflix-light-gray);
            margin-top: 4px;
        }
        
        .blanket-actions {
            display: flex;
            gap: 8px;
        }
        
        .blanket-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--netflix-gray);
            color: var(--netflix-white);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .blanket-btn:hover {
            background: var(--netflix-red);
            color: white;
            transform: scale(1.05);
            border-color: var(--netflix-red);
        }
        
        .blanket-btn.edit {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .blanket-btn.edit:hover {
            background: #FFC107;
            border-color: #FFC107;
        }
        
        .blanket-form {
            background: rgba(255,255,255,0.05);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 2px dashed var(--netflix-gray);
            margin-top: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer;
        }
        
        .temp-range {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .temp-input {
            width: 80px;
            text-align: center;
        }
        
        .blanket-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .type-light { background: rgba(0, 168, 255, 0.2); color: var(--weather-blue); }
        .type-medium { background: rgba(142, 68, 173, 0.2); color: #8E44AD; }
        .type-heavy { background: rgba(229, 9, 20, 0.2); color: var(--netflix-red); }
        .type-none { background: rgba(0, 210, 211, 0.2); color: #00D2D3; }
        .type-custom { background: rgba(255, 193, 7, 0.2); color: #FFC107; }
        
        /* Styles pour les recommandations personnalisées */
        .custom-recommendation {
            background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,193,7,0.05));
            border: 2px solid rgba(255,193,7,0.3);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
        }
        
        .custom-recommendation::before {
            content: '★ PERSONNALISÉE';
            position: absolute;
            top: -10px;
            left: 16px;
            background: #FFC107;
            color: var(--netflix-black);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
        }
        
        .blanket-match {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0.5rem 0;
        }
        
        .match-details {
            flex: 1;
        }
        
        .match-percentage {
            font-weight: 900;
            font-size: 0.9rem;
            color: #FFC107;
        }

        /* ===== RESPONSIVE DESIGN ===== */

        /* Tablettes (768px et plus) */
        @media (min-width: 768px) {
            .container {
                padding: 0 24px;
            }

            header {
                padding: 2rem 0;
                margin-bottom: 3rem;
            }

            h1 {
                font-size: 2.5rem;
                gap: 15px;
            }

            .subtitle {
                font-size: 1.2rem;
            }

            .settings-btn {
                top: 2rem;
                right: 2rem;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 400px;
                gap: 2.5rem;
                align-items: start;
            }

            .input-section {
                padding: 2rem;
            }

            .history-section {
                padding: 2rem;
            }

            .meteo-section.enhanced {
                padding: 2rem;
            }

            .weather-actions {
                flex-direction: row;
            }

            .weather-actions .btn {
                flex: 1;
            }

            .radio-group {
                flex-direction: row;
            }

            .radio-option {
                min-width: 140px;
            }

            .temperature-display {
                font-size: 4.5rem;
            }

            .recommendation {
                font-size: 2rem;
            }

            .guide-grid {
                flex-direction: row;
            }

            .guide-card {
                flex: 1;
            }

            .city-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .form-row {
                flex-wrap: nowrap;
            }
        }

        /* Desktop (1024px et plus) */
        @media (min-width: 1024px) {
            h1 {
                font-size: 3rem;
            }

            .input-section:hover {
                transform: translateY(-5px);
            }

            .history-section:hover {
                transform: translateY(-5px);
            }

            .meteo-section.enhanced:hover {
                transform: translateY(-5px);
            }

            .guide-card:hover {
                transform: translateY(-8px);
            }

            .history-item:hover {
                transform: translateX(5px);
            }

            .temperature-range:hover {
                transform: translateX(5px);
            }

            .city-card:hover {
                transform: translateY(-5px);
            }

            .blanket-item:hover {
                transform: translateX(5px);
            }
        }

        /* Grands écrans (1200px et plus) */
        @media (min-width: 1200px) {
            .container {
                padding: 0 32px;
            }

            .main-content {
                gap: 3rem;
            }
        }

        /* Orientation paysage sur mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 1rem 0;
                margin-bottom: 1.5rem;
            }

            .input-section,
            .history-section,
            .meteo-section.enhanced {
                padding: 1rem;
            }

            .modal {
                max-height: 80vh;
            }

            .history-list {
                max-height: 200px;
            }

            .blanket-list {
                max-height: 200px;
            }
        }

        /* Support pour les appareils avec notch */
        @supports (padding: max(0px)) {
            .container {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
            
            header {
                padding-top: max(1.5rem, env(safe-area-inset-top));
            }
            
            footer {
                padding-bottom: max(2rem, env(safe-area-inset-bottom));
            }
        }

        /* Amélioration de l'accessibilité */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Prévention du zoom sur iOS pour les inputs */
        @media screen and (max-width: 768px) {
            input[type="number"],
            input[type="text"],
            select {
                font-size: 16px; /* Empêche le zoom automatique sur iOS */
            }

            .city-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .form-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-horse" aria-hidden="true"></i> COUVERTURES POUR <span id="horse-name">ALDO</span></h1>
            <p class="subtitle">Pour <span id="owner-name">Stéphanie</span> – Propriétaire attentionnée</p>
            <button class="settings-btn" id="open-settings" aria-label="Ouvrir les paramètres">
                <i class="fas fa-cog" aria-hidden="true"></i>
            </button>
        </div>
    </header>

    <main class="container">
        <div class="main-content">
            <div class="input-section">
                <div class="form-group">
                    <label for="temperature"><i class="fas fa-thermometer-half" aria-hidden="true"></i> TEMPÉRATURE MINIMALE NOCTURNE (°C)</label>
                    <div class="input-with-icon">
                        <i class="fas fa-temperature-low" aria-hidden="true"></i>
                        <input type="number" id="temperature" placeholder="Ex: 5" min="-20" max="30" step="0.1" inputmode="decimal" aria-describedby="temperature-help">
                    </div>
                    <div id="temperature-help" class="error-message" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Veuillez entrer une température valide entre -20°C et 30°C
                    </div>
                </div>

                <!-- Section Météo avec OpenMeteo -->
                <div class="meteo-section enhanced">
                    <div class="meteo-header">
                        <span><i class="fas fa-satellite" aria-hidden="true"></i> MÉTÉO AUTOMATIQUE</span>
                        <div class="location-badge" id="location-badge">
                            <i class="fas fa-location-dot" aria-hidden="true"></i>
                            <span id="current-location">Chargement...</span>
                        </div>
                    </div>
                    
                    <div class="weather-widget" id="weather-widget">
                        <div class="weather-loading" id="weather-loading">
                            <div class="loading-spinner"></div>
                            <p>Récupération de la météo...</p>
                        </div>
                        
                        <div class="current-weather" id="current-weather" style="display: none;">
                            <div class="temp-display">
                                <span id="current-min-temp">--</span>
                                <small>°C min cette nuit</small>
                            </div>
                            <button id="use-weather-temp" class="btn btn-meteo" disabled>
                                <i class="fas fa-cloud-upload-alt"></i>
                                UTILISER CETTE TEMPÉRATURE
                            </button>
                        </div>
                        
                        <div class="weather-error" id="weather-error" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Impossible de récupérer la météo</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Veuillez saisir la température manuellement</p>
                        </div>
                    </div>
                    
                    <div class="weather-actions">
                        <button id="refresh-weather" class="btn btn-outline">
                            <i class="fas fa-sync-alt"></i>
                            ACTUALISER
                        </button>
                    </div>

                    <!-- Lien discret vers Météo France -->
                    <div class="meteo-france-link" id="meteo-france-link" style="display: none;">
                        <a href="#" target="_blank" id="meteo-france-url">
                            <i class="fas fa-external-link-alt"></i>
                            Vérifier sur Météo France
                        </a>
                    </div>
                </div>

                <!-- BOUTON POUR OUVRIR LA POPUP DES COUVERTURES -->
                <button id="open-blankets" class="btn">
                    <i class="fas fa-warehouse" aria-hidden="true"></i> GÉRER MES COUVERTURES
                </button>

                <button id="open-guide" class="btn btn-outline">
                    <i class="fas fa-book" aria-hidden="true"></i> AFFICHER LE GUIDE DES COUVERTURES
                </button>
            </div>

            <!-- Section Historique -->
            <div class="history-section">
                <div class="history-header">
                    <div class="history-title">
                        <i class="fas fa-history"></i> HISTORIQUE
                    </div>
                    <div class="history-actions">
                        <button class="history-btn" id="clear-history" title="Effacer l'historique">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="history-btn" id="toggle-history" title="Réduire/Agrandir">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="history-list" id="history-list">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
        </div>
    </main>

    <!-- Popup Résultat -->
    <div id="result-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="result-title">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-horse" aria-hidden="true"></i> 
                    <span id="result-title">RECOMMANDATION POUR <span id="horse-name-3">ALDO</span></span>
                    <span id="tonte-indicator-modal" class="tonte-indicator tondu">
                        <i class="fas fa-cut" aria-hidden="true"></i> TONDU
                    </span>
                </div>
                <button class="close-modal" id="close-result" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body" id="result-modal-body">
                <!-- Rempli dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Popup Guide -->
    <div id="guide-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="guide-title">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="guide-title"><i class="fas fa-book-open" aria-hidden="true"></i> GUIDE DES COUVERTURES</div>
                <button class="close-modal" id="close-guide" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body">
                <div class="guide-grid">
                    <div class="guide-card">
                        <div class="guide-header">
                            <i class="fas fa-snowflake" aria-hidden="true"></i> <span id="horse-name-4">ALDO</span> EST TONDU
                        </div>
                        <div class="guide-body">
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-high" aria-hidden="true"></i> 10° à 15°</span>
                                <span class="recommendation-text light-blanket">Chemise d'écurie</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-high" aria-hidden="true"></i> 5° à 10°</span>
                                <span class="recommendation-text light-blanket">Polaire ou couverture (100–150 gr)</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> 0° à 5°</span>
                                <span class="recommendation-text medium-blanket">Couverture mi-saison (200 gr)</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> -5° à 0°</span>
                                <span class="recommendation-text heavy-blanket">Couverture chaude (300 gr)</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> -10° à -5°</span>
                                <span class="recommendation-text heavy-blanket">Couverture épaisse (400 gr)</span>
                            </div>
                        </div>
                    </div>
                    <div class="guide-card">
                        <div class="guide-header">
                            <i class="fas fa-wind" aria-hidden="true"></i> <span id="horse-name-5">ALDO</span> N'EST PAS TONDU
                        </div>
                        <div class="guide-body">
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-high" aria-hidden="true"></i> 10° à 15°</span>
                                <span class="recommendation-text no-blanket">Pas de couverture</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-high" aria-hidden="true"></i> 5° à 10°</span>
                                <span class="recommendation-text light-blanket">Polaire ou couverture</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> 0° à 5°</span>
                                <span class="recommendation-text light-blanket">Polaire (100 gr)</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> -5° à 0°</span>
                                <span class="recommendation-text medium-blanket">Couverture mi-saison (200 gr)</span>
                            </div>
                            <div class="temperature-range">
                                <span class="range"><i class="fas fa-temperature-low" aria-hidden="true"></i> -10° à -5°</span>
                                <span class="recommendation-text heavy-blanket">Couverture épaisse (300 gr)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Paramètres -->
    <div id="settings-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="settings-title">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="settings-title"><i class="fas fa-cog" aria-hidden="true"></i> PARAMÈTRES</div>
                <button class="close-modal" id="close-settings" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body">
                <form class="settings-form" id="settings-form">
                    <div class="settings-group">
                        <label class="settings-label" for="settings-horse-name">
                            <i class="fas fa-horse" aria-hidden="true"></i> NOM DU CHEVAL
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                            <input type="text" id="settings-horse-name" placeholder="Ex: Aldo" value="Aldo">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">
                            <i class="fas fa-cut" aria-hidden="true"></i> ÉTAT DE LA TONTE
                        </label>
                        <div class="radio-group">
                            <div class="radio-option" id="settings-tondu-oui-option">
                                <input type="radio" id="settings-tondu-oui" name="settings-tondu" value="oui" checked>
                                <label for="settings-tondu-oui">TONDU</label>
                            </div>
                            <div class="radio-option" id="settings-tondu-non-option">
                                <input type="radio" id="settings-tondu-non" name="settings-tondu" value="non">
                                <label for="settings-tondu-non">NON TONDU</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">
                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i> LOCALISATION
                        </label>
                        <div class="radio-group">
                            <div class="radio-option" id="location-auto-option">
                                <input type="radio" id="location-auto" name="location-type" value="auto" checked>
                                <label for="location-auto">AUTOMATIQUE (GPS)</label>
                            </div>
                            <div class="radio-option" id="location-manual-option">
                                <input type="radio" id="location-manual" name="location-type" value="manual">
                                <label for="location-manual">MANUELLE</label>
                            </div>
                        </div>
                        
                        <div id="manual-location-section" style="display: none; margin-top: 1rem;">
                            <div class="city-select-container">
                                <i class="fas fa-city" aria-hidden="true"></i>
                                <select id="settings-city-select">
                                    <option value="">Choisir une ville...</option>
                                    <!-- Rempli dynamiquement par JavaScript -->
                                </select>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--netflix-light-gray);">
                                <i class="fas fa-info-circle"></i> Sélectionnez une ville française compatible
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label" for="settings-owner-name">
                            <i class="fas fa-user" aria-hidden="true"></i> NOM DU PROPRIÉTAIRE
                        </label>
                        <div class="input-with-icon">
                            <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                            <input type="text" id="settings-owner-name" placeholder="Ex: Stéphanie" value="Stéphanie">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-settings">
                        <i class="fas fa-save" aria-hidden="true"></i> ENREGISTRER LES PARAMÈTRES
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Popup Sélection de Ville -->
    <div id="city-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="city-title">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="city-title">
                    <i class="fas fa-map-marker-alt" aria-hidden="true"></i> CHOISIR UNE VILLE
                </div>
                <button class="close-modal" id="close-city" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body">
                <div class="city-grid">
                    <button class="city-card" data-city="Aix-les-Bains">
                        <i class="fas fa-mountain"></i>
                        <span>AIX-LES-BAINS</span>
                    </button>
                    <button class="city-card" data-city="Chambéry">
                        <i class="fas fa-alps"></i>
                        <span>CHAMBÉRY</span>
                    </button>
                    <button class="city-card" data-city="Lyon">
                        <i class="fas fa-city"></i>
                        <span>LYON</span>
                    </button>
                    <button class="city-card" data-city="Grenoble">
                        <i class="fas fa-mountain"></i>
                        <span>GRENOBLE</span>
                    </button>
                    <button class="city-card" data-city="Paris">
                        <i class="fas fa-landmark"></i>
                        <span>PARIS</span>
                    </button>
                    <button class="city-card" data-city="Marseille">
                        <i class="fas fa-sun"></i>
                        <span>MARSEILLE</span>
                    </button>
                    <button class="city-card" data-city="Bordeaux">
                        <i class="fas fa-wine-glass"></i>
                        <span>BORDEAUX</span>
                    </button>
                    <button class="city-card" data-city="Toulouse">
                        <i class="fas fa-brick"></i>
                        <span>TOULOUSE</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOUVELLE POPUP : Gestion des Couvertures -->
    <div id="blankets-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="blankets-title">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="blankets-title">
                    <i class="fas fa-warehouse" aria-hidden="true"></i> MES COUVERTURES DISPONIBLES
                </div>
                <button class="close-modal" id="close-blankets" aria-label="Fermer">&times;</button>
            </div>
            <div class="modal-body">
                <div class="blanket-management">
                    <div class="blanket-list" id="blanket-list">
                        <!-- Rempli dynamiquement par JavaScript -->
                    </div>
                    
                    <button id="add-blanket-btn" class="btn" style="margin: 1rem 0;">
                        <i class="fas fa-plus" aria-hidden="true"></i> AJOUTER UNE COUVERTURE
                    </button>
                    
                    <div class="blanket-form" id="blanket-form" style="display: none;">
                        <h3 style="margin-bottom: 1rem; color: var(--netflix-red);">
                            <i class="fas fa-edit"></i> <span id="form-title">NOUVELLE COUVERTURE</span>
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom de la couverture</label>
                                <input type="text" id="blanket-name" placeholder="Ex: Couverture d'hiver bleue" class="input-with-icon" style="padding-left: 16px;">
                            </div>
                            <div class="form-group">
                                <label>Grammage (g/m²)</label>
                                <input type="number" id="blanket-weight" placeholder="Ex: 200" min="0" max="500" class="input-with-icon" style="padding-left: 16px;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Couleur</label>
                                <div class="color-picker">
                                    <div class="color-preview" id="color-preview" style="background: #E50914;"></div>
                                    <input type="color" id="blanket-color" value="#E50914" style="opacity: 0; position: absolute; width: 30px; height: 30px; cursor: pointer;">
                                    <span id="color-value">Rouge Netflix</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="blanket-type" class="input-with-icon" style="padding-left: 16px;">
                                    <option value="light">Légère (0-150g)</option>
                                    <option value="medium">Mi-saison (150-250g)</option>
                                    <option value="heavy">Chaude (250g+)</option>
                                    <option value="none">Chemise d'écurie</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Plage de température idéale</label>
                                <div class="temp-range">
                                    <input type="number" id="temp-min" placeholder="Min" class="temp-input input-with-icon" style="padding-left: 16px;">
                                    <span>à</span>
                                    <input type="number" id="temp-max" placeholder="Max" class="temp-input input-with-icon" style="padding-left: 16px;">
                                    <span>°C</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Utilisation</label>
                                <select id="blanket-usage" class="input-with-icon" style="padding-left: 16px;">
                                    <option value="both">Écurie & Extérieur</option>
                                    <option value="stable">Écurie uniquement</option>
                                    <option value="outdoor">Extérieur uniquement</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="blanket-waterproof" style="margin-right: 8px;">
                                    Imperméable
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="blanket-breathable" style="margin-right: 8px;" checked>
                                    Respirante
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions" style="display: flex; gap: 12px; margin-top: 1.5rem;">
                            <button type="button" id="save-blanket" class="btn" style="flex: 1;">
                                <i class="fas fa-save"></i> SAUVEGARDER
                            </button>
                            <button type="button" id="cancel-blanket" class="btn btn-outline" style="flex: 1;">
                                <i class="fas fa-times"></i> ANNULER
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p><i class="fas fa-heart" style="color: var(--netflix-red);" aria-hidden="true"></i> POUR <span id="horse-name-6">ALDO</span> – <span id="owner-name-2">STÉPHANIE</span></p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Éléments DOM
            const temperatureInput = document.getElementById('temperature');
            const openGuideBtn = document.getElementById('open-guide');
            const openSettingsBtn = document.getElementById('open-settings');
            const closeResultBtn = document.getElementById('close-result');
            const closeGuideBtn = document.getElementById('close-guide');
            const closeSettingsBtn = document.getElementById('close-settings');
            const resultModal = document.getElementById('result-modal');
            const guideModal = document.getElementById('guide-modal');
            const settingsModal = document.getElementById('settings-modal');
            const resultModalBody = document.getElementById('result-modal-body');
            const settingsForm = document.getElementById('settings-form');
            const tonteIndicatorModal = document.getElementById('tonte-indicator-modal');
            const errorMessage = document.getElementById('temperature-help');
            const historyList = document.getElementById('history-list');
            const clearHistoryBtn = document.getElementById('clear-history');
            const toggleHistoryBtn = document.getElementById('toggle-history');
            
            // Éléments météo
            const weatherWidget = document.getElementById('weather-widget');
            const weatherLoading = document.getElementById('weather-loading');
            const currentWeather = document.getElementById('current-weather');
            const weatherError = document.getElementById('weather-error');
            const currentMinTemp = document.getElementById('current-min-temp');
            const currentLocation = document.getElementById('current-location');
            const useWeatherTempBtn = document.getElementById('use-weather-temp');
            const refreshWeatherBtn = document.getElementById('refresh-weather');
            const locationBadge = document.getElementById('location-badge');
            
            // Éléments pour le lien Météo France
            const meteoFranceLink = document.getElementById('meteo-france-link');
            const meteoFranceUrl = document.getElementById('meteo-france-url');
            
            // Éléments pour les paramètres de localisation
            const locationAuto = document.getElementById('location-auto');
            const locationManual = document.getElementById('location-manual');
            const manualLocationSection = document.getElementById('manual-location-section');
            const settingsCitySelect = document.getElementById('settings-city-select');
            
            // Éléments pour la sélection de ville
            const cityModal = document.getElementById('city-modal');
            const closeCityBtn = document.getElementById('close-city');
            const cityCards = document.querySelectorAll('.city-card');
            
            // Éléments pour les noms personnalisés
            const horseNameElements = [
                document.getElementById('horse-name'),
                document.getElementById('horse-name-3'),
                document.getElementById('horse-name-4'),
                document.getElementById('horse-name-5'),
                document.getElementById('horse-name-6')
            ];
            const ownerNameElements = [
                document.getElementById('owner-name'),
                document.getElementById('owner-name-2')
            ];
            
            // ==================== NOUVEAUX ÉLÉMENTS POUR LA GESTION DES COUVERTURES ====================
            
            const openBlanketsBtn = document.getElementById('open-blankets');
            const blanketsModal = document.getElementById('blankets-modal');
            const closeBlanketsBtn = document.getElementById('close-blankets');
            const blanketList = document.getElementById('blanket-list');
            const addBlanketBtn = document.getElementById('add-blanket-btn');
            const blanketForm = document.getElementById('blanket-form');
            const saveBlanketBtn = document.getElementById('save-blanket');
            const cancelBlanketBtn = document.getElementById('cancel-blanket');
            const formTitle = document.getElementById('form-title');
            
            // Éléments du formulaire de couverture
            const blanketNameInput = document.getElementById('blanket-name');
            const blanketWeightInput = document.getElementById('blanket-weight');
            const blanketColorInput = document.getElementById('blanket-color');
            const colorPreview = document.getElementById('color-preview');
            const colorValue = document.getElementById('color-value');
            const blanketTypeSelect = document.getElementById('blanket-type');
            const tempMinInput = document.getElementById('temp-min');
            const tempMaxInput = document.getElementById('temp-max');
            const blanketUsageSelect = document.getElementById('blanket-usage');
            const blanketWaterproofCheck = document.getElementById('blanket-waterproof');
            const blanketBreathableCheck = document.getElementById('blanket-breathable');

            // Paramètres des règles
            const rulesTondu = [
                { min: 10, max: 15, recommendation: "Chemise d'écurie", details: "Une simple chemise d'écurie suffit.", type: "light" },
                { min: 5, max: 10, recommendation: "Polaire ou couverture (100–150 gr)", details: "Utilisez une polaire ou une couverture d'écurie.", type: "light" },
                { min: 0, max: 5, recommendation: "Couverture mi-saison (200 gr)", details: "Utilisez une couverture d'extérieur ou d'écurie.", type: "medium" },
                { min: -5, max: 0, recommendation: "Couverture chaude (300 gr)", details: "Utilisez une couverture d'extérieur ou d'écurie.", type: "heavy" },
                { min: -10, max: -5, recommendation: "Couverture épaisse (400 gr)", details: "Utilisez une couverture d'extérieur ou d'écurie.", type: "heavy" }
            ];

            const rulesNonTondu = [
                { min: 10, max: 15, recommendation: "Pas de couverture", details: "Aucune couverture n'est nécessaire.", type: "none" },
                { min: 5, max: 10, recommendation: "Polaire ou couverture", details: "Utilisez une polaire ou une couverture d'écurie.", type: "light" },
                { min: 0, max: 5, recommendation: "Polaire (100 gr)", details: "Utilisez une polaire ou une couverture d'écurie.", type: "light" },
                { min: -5, max: 0, recommendation: "Couverture mi-saison (200 gr)", details: "Utilisez une couverture d'extérieur ou d'écurie.", type: "medium" },
                { min: -10, max: -5, recommendation: "Couverture épaisse (300 gr)", details: "Utilisez une couverture d'extérieur ou d'écurie.", type: "heavy" }
            ];

            // ==================== BASE DE DONNÉES DES VILLES ====================

            const citiesDatabase = {
                "Aix-les-Bains": { 
                    lat: 45.6886, 
                    lng: 5.9150,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/aix-les-bains/73100",
                    region: "Auvergne-Rhône-Alpes"
                },
                "Chambéry": { 
                    lat: 45.5646, 
                    lng: 5.9178,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/chambery/73000",
                    region: "Auvergne-Rhône-Alpes"
                },
                "Lyon": { 
                    lat: 45.75, 
                    lng: 4.85,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/lyon/69000",
                    region: "Auvergne-Rhône-Alpes"
                },
                "Grenoble": { 
                    lat: 45.1667, 
                    lng: 5.7167,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/grenoble/38000",
                    region: "Auvergne-Rhône-Alpes"
                },
                "Paris": { 
                    lat: 48.8566, 
                    lng: 2.3522,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/paris/75000",
                    region: "Île-de-France"
                },
                "Marseille": { 
                    lat: 43.2965, 
                    lng: 5.3698,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/marseille/13000",
                    region: "Provence-Alpes-Côte d'Azur"
                },
                "Bordeaux": { 
                    lat: 44.8378, 
                    lng: -0.5792,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/bordeaux/33000",
                    region: "Nouvelle-Aquitaine"
                },
                "Toulouse": { 
                    lat: 43.6047, 
                    lng: 1.4442,
                    meteofrance: "https://meteofrance.com/previsions-meteo-france/toulouse/31000",
                    region: "Occitanie"
                }
            };

            // ==================== BASE DE DONNÉES DES COUVERTURES ====================

            const defaultBlankets = [
                {
                    id: 1,
                    name: "Chemise d'écurie",
                    weight: 0,
                    color: "#00A8FF",
                    type: "none",
                    tempMin: 10,
                    tempMax: 15,
                    usage: "stable",
                    waterproof: false,
                    breathable: true,
                    custom: false
                },
                {
                    id: 2,
                    name: "Polaire légère",
                    weight: 100,
                    color: "#8E44AD",
                    type: "light",
                    tempMin: 5,
                    tempMax: 10,
                    usage: "both",
                    waterproof: false,
                    breathable: true,
                    custom: false
                },
                {
                    id: 3,
                    name: "Couverture mi-saison",
                    weight: 200,
                    color: "#E50914",
                    type: "medium",
                    tempMin: 0,
                    tempMax: 5,
                    usage: "both",
                    waterproof: true,
                    breathable: true,
                    custom: false
                },
                {
                    id: 4,
                    name: "Couverture d'hiver",
                    weight: 300,
                    color: "#FFC107",
                    type: "heavy",
                    tempMin: -5,
                    tempMax: 0,
                    usage: "outdoor",
                    waterproof: true,
                    breathable: true,
                    custom: false
                },
                {
                    id: 5,
                    name: "Couverture épaisse",
                    weight: 400,
                    color: "#00D2D3",
                    type: "heavy",
                    tempMin: -10,
                    tempMax: -5,
                    usage: "outdoor",
                    waterproof: true,
                    breathable: true,
                    custom: false
                }
            ];
            
            const colorNames = {
                "#E50914": "Rouge Netflix",
                "#00A8FF": "Bleu Météo",
                "#8E44AD": "Violet",
                "#00D2D3": "Turquoise",
                "#FFC107": "Jaune Or",
                "#28A745": "Vert",
                "#6F42C1": "Pourpre",
                "#FD7E14": "Orange",
                "#20C997": "Vert Menthe",
                "#DC3545": "Rouge Vif"
            };

            // Variables d'état
            let isTondu = true;
            let lastFocusedElement = null;
            let isHistoryCollapsed = false;
            let lastSavedEntry = null;
            let currentWeatherData = null;
            let currentLocationType = 'auto';
            let currentManualCity = 'Aix-les-Bains';
            let currentBlankets = [];
            let editingBlanketId = null;

            // ==================== FONCTIONS MÉTÉO ====================

            function getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Géolocalisation non supportée'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        position => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                type: 'auto'
                            });
                        },
                        error => {
                            console.error('Erreur géolocalisation:', error);
                            reject(error);
                        },
                        { 
                            timeout: 10000,
                            enableHighAccuracy: false,
                            maximumAge: 300000
                        }
                    );
                });
            }

            async function fetchWeatherData(lat, lng) {
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_min,temperature_2m_max&timezone=auto&forecast_days=1`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Erreur API météo');
                    
                    const data = await response.json();
                    
                    return {
                        minTemp: data.daily.temperature_2m_min[0],
                        maxTemp: data.daily.temperature_2m_max[0],
                        location: await getLocationName(lat, lng),
                        coordinates: { lat, lng }
                    };
                } catch (error) {
                    console.error('Erreur récupération météo:', error);
                    throw error;
                }
            }

            async function getLocationName(lat, lng) {
                try {
                    let closestCity = null;
                    let minDistance = Number.MAX_VALUE;

                    Object.entries(citiesDatabase).forEach(([cityName, coords]) => {
                        const distance = Math.sqrt(
                            Math.pow(coords.lat - lat, 2) + Math.pow(coords.lng - lng, 2)
                        );
                        if (distance < minDistance && distance < 1.0) {
                            minDistance = distance;
                            closestCity = cityName;
                        }
                    });

                    if (closestCity) {
                        return closestCity;
                    }

                    return "Localisation GPS";

                } catch (error) {
                    console.error('Erreur géocodage:', error);
                    return "Localisation GPS";
                }
            }

            function populateCitySelect() {
                settingsCitySelect.innerHTML = '<option value="">Choisir une ville...</option>';
                
                const sortedCities = Object.keys(citiesDatabase).sort((a, b) => {
                    if (citiesDatabase[a].region === citiesDatabase[b].region) {
                        return a.localeCompare(b);
                    }
                    return citiesDatabase[a].region.localeCompare(citiesDatabase[b].region);
                });
                
                let currentRegion = '';
                sortedCities.forEach(cityName => {
                    const city = citiesDatabase[cityName];
                    
                    if (city.region !== currentRegion) {
                        currentRegion = city.region;
                        const group = document.createElement('optgroup');
                        group.label = currentRegion;
                        settingsCitySelect.appendChild(group);
                    }
                    
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    settingsCitySelect.appendChild(option);
                });
                
                settingsCitySelect.value = currentManualCity;
            }

            async function loadWeather() {
                showWeatherLoading();
                
                try {
                    let weatherData;
                    
                    if (currentLocationType === 'auto') {
                        const location = await getUserLocation();
                        weatherData = await fetchWeatherData(location.lat, location.lng);
                    } else {
                        const cityCoords = citiesDatabase[currentManualCity];
                        if (!cityCoords) {
                            throw new Error('Ville non trouvée');
                        }
                        weatherData = await fetchWeatherData(cityCoords.lat, cityCoords.lng);
                        weatherData.location = currentManualCity;
                    }
                    
                    currentWeatherData = weatherData;
                    displayWeatherData(weatherData);
                    
                    saveLocationPreferences();
                    
                } catch (error) {
                    console.error('Erreur chargement météo:', error);
                    showWeatherError();
                    
                    try {
                        const lastLocation = localStorage.getItem('lastLocation');
                        if (lastLocation) {
                            const location = JSON.parse(lastLocation);
                            const weatherData = await fetchWeatherData(location.lat, location.lng);
                            currentWeatherData = weatherData;
                            displayWeatherData(weatherData);
                            return;
                        }
                    } catch (fallbackError) {
                        console.error('Erreur fallback:', fallbackError);
                        await useAixLesBainsAsFallback();
                    }
                }
            }

            function displayWeatherData(weatherData) {
                currentMinTemp.textContent = Math.round(weatherData.minTemp);
                currentLocation.textContent = weatherData.location;
                
                updateLocationBadgeStyle(weatherData.location);
                
                useWeatherTempBtn.disabled = false;
                
                weatherLoading.style.display = 'none';
                weatherError.style.display = 'none';
                currentWeather.style.display = 'flex';
                
                updateMeteoFranceLink(weatherData.location);
                
                localStorage.setItem('lastLocation', JSON.stringify({
                    lat: weatherData.coordinates.lat,
                    lng: weatherData.coordinates.lng,
                    name: weatherData.location,
                    timestamp: Date.now()
                }));
            }

            function updateMeteoFranceLink(locationName) {
                if (citiesDatabase[locationName] && citiesDatabase[locationName].meteofrance) {
                    meteoFranceUrl.href = citiesDatabase[locationName].meteofrance;
                    meteoFranceLink.style.display = 'block';
                } else {
                    meteoFranceLink.style.display = 'none';
                }
            }

            function updateLocationBadgeStyle(locationName) {
                if (locationName === "Localisation GPS") {
                    locationBadge.style.background = "rgba(0, 168, 255, 0.2)";
                    locationBadge.style.borderColor = "rgba(0, 168, 255, 0.4)";
                    locationBadge.style.color = "var(--weather-blue)";
                } else {
                    locationBadge.style.background = "rgba(0, 210, 211, 0.2)";
                    locationBadge.style.borderColor = "rgba(0, 210, 211, 0.4)";
                    locationBadge.style.color = "#00D2D3";
                }
            }

            function showWeatherLoading() {
                weatherLoading.style.display = 'flex';
                currentWeather.style.display = 'none';
                weatherError.style.display = 'none';
                useWeatherTempBtn.disabled = true;
                currentLocation.textContent = 'Chargement...';
                locationBadge.style.background = "rgba(255, 255, 255, 0.1)";
                locationBadge.style.borderColor = "var(--netflix-gray)";
                locationBadge.style.color = "var(--netflix-light-gray)";
                meteoFranceLink.style.display = 'none';
            }

            function showWeatherError() {
                weatherLoading.style.display = 'none';
                currentWeather.style.display = 'none';
                weatherError.style.display = 'block';
                useWeatherTempBtn.disabled = true;
                currentLocation.textContent = 'Erreur';
                locationBadge.style.background = "rgba(229, 9, 20, 0.2)";
                locationBadge.style.borderColor = "rgba(229, 9, 20, 0.4)";
                locationBadge.style.color = "var(--netflix-red)";
                meteoFranceLink.style.display = 'none';
            }

            function useWeatherTemperature() {
                if (currentWeatherData && currentWeatherData.minTemp !== null) {
                    temperatureInput.value = Math.round(currentWeatherData.minTemp);
                    calculateRecommendation();
                }
            }

            async function useAixLesBainsAsFallback() {
                try {
                    const cityCoords = citiesDatabase['Aix-les-Bains'];
                    const weatherData = await fetchWeatherData(cityCoords.lat, cityCoords.lng);
                    weatherData.location = 'Aix-les-Bains (secours)';
                    currentWeatherData = weatherData;
                    displayWeatherData(weatherData);
                } catch (error) {
                    showWeatherError();
                }
            }

            function saveLocationPreferences() {
                const preferences = {
                    locationType: currentLocationType,
                    manualCity: currentManualCity,
                    timestamp: Date.now()
                };
                localStorage.setItem('locationPreferences', JSON.stringify(preferences));
            }

            function loadLocationPreferences() {
                const saved = localStorage.getItem('locationPreferences');
                if (saved) {
                    const preferences = JSON.parse(saved);
                    currentLocationType = preferences.locationType;
                    currentManualCity = preferences.manualCity || 'Aix-les-Bains';
                    
                    if (currentLocationType === 'manual') {
                        locationManual.checked = true;
                        locationAuto.checked = false;
                        manualLocationSection.style.display = 'block';
                        settingsCitySelect.value = currentManualCity;
                    } else {
                        locationAuto.checked = true;
                        locationManual.checked = false;
                        manualLocationSection.style.display = 'none';
                    }
                }
            }

            // ==================== FONCTIONS GESTION DES COUVERTURES ====================

            function initializeBlanketManagement() {
                loadBlankets();
                setupBlanketEventListeners();
            }
            
            function loadBlankets() {
                const savedBlankets = localStorage.getItem('horseBlankets');
                if (savedBlankets) {
                    currentBlankets = JSON.parse(savedBlankets);
                } else {
                    currentBlankets = [...defaultBlankets];
                    saveBlankets();
                }
            }
            
            function saveBlankets() {
                localStorage.setItem('horseBlankets', JSON.stringify(currentBlankets));
            }
            
            function setupBlanketEventListeners() {
                openBlanketsBtn.addEventListener('click', () => {
                    renderBlanketList();
                    openModal(blanketsModal);
                });
                
                closeBlanketsBtn.addEventListener('click', () => {
                    closeModal(blanketsModal);
                    hideBlanketForm();
                });
                
                blanketsModal.addEventListener('click', (e) => {
                    if (e.target === blanketsModal) {
                        closeModal(blanketsModal);
                        hideBlanketForm();
                    }
                });
                
                addBlanketBtn.addEventListener('click', showBlanketForm);
                saveBlanketBtn.addEventListener('click', saveBlanket);
                cancelBlanketBtn.addEventListener('click', hideBlanketForm);
                blanketColorInput.addEventListener('input', updateColorPreview);
            }
            
            function showBlanketForm() {
                resetBlanketForm();
                blanketForm.style.display = 'block';
                addBlanketBtn.style.display = 'none';
                formTitle.textContent = 'NOUVELLE COUVERTURE';
                blanketNameInput.focus();
            }
            
            function hideBlanketForm() {
                blanketForm.style.display = 'none';
                addBlanketBtn.style.display = 'block';
                editingBlanketId = null;
                formTitle.textContent = 'NOUVELLE COUVERTURE';
            }
            
            function resetBlanketForm() {
                blanketNameInput.value = '';
                blanketWeightInput.value = '';
                blanketColorInput.value = '#E50914';
                blanketTypeSelect.value = 'light';
                tempMinInput.value = '';
                tempMaxInput.value = '';
                blanketUsageSelect.value = 'both';
                blanketWaterproofCheck.checked = false;
                blanketBreathableCheck.checked = true;
                updateColorPreview();
            }
            
            function updateColorPreview() {
                const color = blanketColorInput.value;
                colorPreview.style.backgroundColor = color;
                colorValue.textContent = colorNames[color] || `Couleur personnalisée (${color})`;
            }
            
            function saveBlanket() {
                const blanketData = {
                    name: blanketNameInput.value.trim(),
                    weight: parseInt(blanketWeightInput.value) || 0,
                    color: blanketColorInput.value,
                    type: blanketTypeSelect.value,
                    tempMin: parseInt(tempMinInput.value) || 0,
                    tempMax: parseInt(tempMaxInput.value) || 10,
                    usage: blanketUsageSelect.value,
                    waterproof: blanketWaterproofCheck.checked,
                    breathable: blanketBreathableCheck.checked,
                    custom: true
                };
                
                if (!blanketData.name) {
                    alert('Veuillez donner un nom à votre couverture');
                    return;
                }
                
                if (editingBlanketId) {
                    const index = currentBlankets.findIndex(b => b.id === editingBlanketId);
                    if (index !== -1) {
                        currentBlankets[index] = { ...currentBlankets[index], ...blanketData };
                    }
                } else {
                    blanketData.id = Date.now();
                    currentBlankets.push(blanketData);
                }
                
                saveBlankets();
                renderBlanketList();
                hideBlanketForm();
                
                if (resultModal.classList.contains('active')) {
                    calculateRecommendation();
                }
            }
            
            function renderBlanketList() {
                if (currentBlankets.length === 0) {
                    blanketList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--netflix-light-gray);">
                            <i class="fas fa-warehouse" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Aucune couverture configurée</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Ajoutez vos premières couvertures pour les voir apparaître ici</p>
                        </div>
                    `;
                    return;
                }
                
                blanketList.innerHTML = currentBlankets.map(blanket => `
                    <div class="blanket-item" data-id="${blanket.id}">
                        <div class="blanket-info">
                            <div class="blanket-color" style="background-color: ${blanket.color};"></div>
                            <div class="blanket-details">
                                <div class="blanket-name">
                                    ${blanket.name}
                                    ${blanket.custom ? '<span class="blanket-type-badge type-custom" style="background: rgba(255,193,7,0.2); color: #FFC107;"><i class="fas fa-star"></i> Perso</span>' : ''}
                                    <span class="blanket-type-badge type-${blanket.type}">
                                        <i class="fas fa-${getTypeIcon(blanket.type)}"></i> ${getTypeLabel(blanket.type)}
                                    </span>
                                </div>
                                <div class="blanket-specs">
                                    ${blanket.weight > 0 ? `${blanket.weight}g/m² • ` : ''}
                                    ${blanket.tempMin}° à ${blanket.tempMax}°C •
                                    ${getUsageLabel(blanket.usage)} •
                                    ${blanket.waterproof ? '💧 Imperméable' : ''}
                                    ${blanket.breathable ? '🌬️ Respirante' : ''}
                                </div>
                            </div>
                        </div>
                        <div class="blanket-actions">
                            <button class="blanket-btn edit" onclick="editBlanket(${blanket.id})" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="blanket-btn" onclick="deleteBlanket(${blanket.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function getTypeIcon(type) {
                const icons = {
                    'none': 'tshirt',
                    'light': 'wind',
                    'medium': 'cloud-sun',
                    'heavy': 'snowflake'
                };
                return icons[type] || 'horse';
            }
            
            function getTypeLabel(type) {
                const labels = {
                    'none': 'Chemise',
                    'light': 'Légère',
                    'medium': 'Mi-saison',
                    'heavy': 'Chaude'
                };
                return labels[type] || type;
            }
            
            function getUsageLabel(usage) {
                const labels = {
                    'both': 'Écurie/Extérieur',
                    'stable': 'Écurie uniquement',
                    'outdoor': 'Extérieur uniquement'
                };
                return labels[usage] || usage;
            }
            
            window.editBlanket = function(id) {
                const blanket = currentBlankets.find(b => b.id === id);
                if (!blanket) return;
                
                editingBlanketId = id;
                blanketNameInput.value = blanket.name;
                blanketWeightInput.value = blanket.weight;
                blanketColorInput.value = blanket.color;
                blanketTypeSelect.value = blanket.type;
                tempMinInput.value = blanket.tempMin;
                tempMaxInput.value = blanket.tempMax;
                blanketUsageSelect.value = blanket.usage;
                blanketWaterproofCheck.checked = blanket.waterproof;
                blanketBreathableCheck.checked = blanket.breathable;
                
                updateColorPreview();
                formTitle.textContent = 'MODIFIER LA COUVERTURE';
                blanketForm.style.display = 'block';
                addBlanketBtn.style.display = 'none';
            };
            
            window.deleteBlanket = function(id) {
                if (confirm('Voulez-vous vraiment supprimer cette couverture ?')) {
                    currentBlankets = currentBlankets.filter(b => b.id !== id);
                    saveBlankets();
                    renderBlanketList();
                    
                    if (resultModal.classList.contains('active')) {
                        calculateRecommendation();
                    }
                }
            };

            // ==================== FONCTIONS EXISTANTES AMÉLIORÉES ====================

            function initializeSettings() {
                const savedHorseName = localStorage.getItem('horseName');
                const savedOwnerName = localStorage.getItem('ownerName');
                const savedIsTondu = localStorage.getItem('isTondu');
                
                if (savedHorseName) {
                    document.getElementById('settings-horse-name').value = savedHorseName;
                    updateHorseName(savedHorseName);
                }
                
                if (savedOwnerName) {
                    document.getElementById('settings-owner-name').value = savedOwnerName;
                    updateOwnerName(savedOwnerName);
                }
                
                if (savedIsTondu) {
                    isTondu = savedIsTondu === 'true';
                    document.getElementById('settings-tondu-oui').checked = isTondu;
                    document.getElementById('settings-tondu-non').checked = !isTondu;
                    updateTonteIndicator();
                }
                
                populateCitySelect();
                loadLocationPreferences();
                loadHistory();
                loadWeather();
            }
            
            function updateHorseName(name) {
                horseNameElements.forEach(element => {
                    if (element) element.textContent = name.toUpperCase();
                });
            }
            
            function updateOwnerName(name) {
                ownerNameElements.forEach(element => {
                    if (element) element.textContent = name.toUpperCase();
                });
            }
            
            function updateTonteIndicator() {
                if (isTondu) {
                    tonteIndicatorModal.innerHTML = '<i class="fas fa-cut" aria-hidden="true"></i> TONDU';
                    tonteIndicatorModal.className = 'tonte-indicator tondu';
                } else {
                    tonteIndicatorModal.innerHTML = '<i class="fas fa-wind" aria-hidden="true"></i> NON TONDU';
                    tonteIndicatorModal.className = 'tonte-indicator non-tondu';
                }
            }

            function validateTemperature(temp) {
                return !isNaN(temp) && temp >= -20 && temp <= 30;
            }

            function isDuplicateEntry(temp, recommendation, type) {
                const history = getHistory();
                const now = new Date();
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
                
                return history.some(entry => {
                    const entryDate = new Date(entry.date);
                    return entry.temperature === temp && 
                           entry.recommendation === recommendation && 
                           entry.type === type &&
                           entryDate > fiveMinutesAgo;
                });
            }

            function saveToHistory(temp, recommendation, details, type) {
                if (isDuplicateEntry(temp, recommendation, type)) {
                    console.log('Entrée dupliquée détectée, non sauvegardée');
                    return;
                }
                
                const history = getHistory();
                const newEntry = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    temperature: temp,
                    recommendation: recommendation,
                    details: details,
                    type: type,
                    horseName: horseNameElements[0].textContent,
                    isTondu: isTondu
                };
                
                history.unshift(newEntry);
                
                if (history.length > 20) {
                    history.splice(20);
                }
                
                localStorage.setItem('blanketHistory', JSON.stringify(history));
                loadHistory();
                
                lastSavedEntry = newEntry;
            }

            function getHistory() {
                const history = localStorage.getItem('blanketHistory');
                return history ? JSON.parse(history) : [];
            }

            function loadHistory() {
                const history = getHistory();
                
                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-history">
                            <i class="fas fa-history"></i>
                            <p>AUCUNE RECOMMANDATION ENCORE</p>
                            <p style="font-size: 0.9rem; margin-top: 1rem;">L'HISTORIQUE APPARAÎTRA AUTOMATIQUEMENT ICI</p>
                        </div>
                    `;
                    return;
                }
                
                historyList.innerHTML = history.map(entry => `
                    <div class="history-item">
                        <div class="history-date">${formatDate(entry.date)}</div>
                        <div class="history-temp">${Math.round(entry.temperature)}°C</div>
                        <div class="history-rec ${entry.type}-blanket">${entry.recommendation}</div>
                        <button class="history-delete" onclick="deleteHistoryEntry(${entry.id})" aria-label="Supprimer cette entrée">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return "AUJOURD'HUI";
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return "HIER";
                } else {
                    return date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'short' 
                    }).toUpperCase();
                }
            }

            window.deleteHistoryEntry = function(id) {
                const history = getHistory();
                const updatedHistory = history.filter(entry => entry.id !== id);
                localStorage.setItem('blanketHistory', JSON.stringify(updatedHistory));
                loadHistory();
            };

            function clearHistory() {
                if (confirm("VOULEZ-VOUS VRAIMENT EFFACER TOUT L'HISTORIQUE ?")) {
                    localStorage.removeItem('blanketHistory');
                    loadHistory();
                }
            }

            function toggleHistory() {
                const historyContainer = document.querySelector('.history-list');
                const toggleIcon = toggleHistoryBtn.querySelector('i');
                
                isHistoryCollapsed = !isHistoryCollapsed;
                
                if (isHistoryCollapsed) {
                    historyContainer.style.maxHeight = '0';
                    historyContainer.style.overflow = 'hidden';
                    toggleIcon.className = 'fas fa-chevron-up';
                } else {
                    historyContainer.style.maxHeight = '300px';
                    historyContainer.style.overflow = 'auto';
                    toggleIcon.className = 'fas fa-chevron-down';
                }
            }

            // ==================== FONCTION calculateRecommendation AMÉLIORÉE ====================

            function calculateRecommendation() {
                const temp = parseFloat(temperatureInput.value);
                const isValid = validateTemperature(temp);
                
                if (!isValid && temperatureInput.value !== '') {
                    errorMessage.style.display = 'flex';
                    temperatureInput.style.borderColor = 'var(--netflix-red)';
                    if (resultModal.classList.contains('active')) {
                        resultModal.classList.remove('active');
                    }
                    return;
                } else {
                    errorMessage.style.display = 'none';
                    temperatureInput.style.borderColor = 'var(--netflix-gray)';
                }

                if (!isValid) {
                    if (resultModal.classList.contains('active')) {
                        resultModal.classList.remove('active');
                    }
                    return;
                }

                // Trouver les couvertures personnalisées qui correspondent
                const matchingBlankets = findMatchingBlankets(temp);
                
                // Règles par défaut
                const rules = isTondu ? rulesTondu : rulesNonTondu;
                let rec = null;
                for (const rule of rules) {
                    if (temp >= rule.min && temp <= rule.max) {
                        rec = rule;
                        break;
                    }
                }

                let icon = "fas fa-horse", colorClass = "";
                if (rec) {
                    switch (rec.type) {
                        case "none": icon = "fas fa-check-circle"; colorClass = "no-blanket"; break;
                        case "light": colorClass = "light-blanket"; break;
                        case "medium": icon = "fas fa-horse-head"; colorClass = "medium-blanket"; break;
                        case "heavy": icon = "fas fa-horse-head"; colorClass = "heavy-blanket"; break;
                    }

                    saveToHistory(temp, rec.recommendation, rec.details, rec.type);

                    // Construction du HTML avec recommandations personnalisées
                    let recommendationHTML = `
                        <div class="temperature-display">${Math.round(temp)}°C</div>
                        <div class="recommendation ${colorClass}"><i class="${icon}" aria-hidden="true"></i> ${rec.recommendation.toUpperCase()}</div>
                        <div class="details">${rec.details}</div>
                    `;
                    
                    // Ajouter les correspondances personnalisées si elles existent
                    if (matchingBlankets.length > 0) {
                        recommendationHTML += `
                            <div class="custom-recommendation">
                                <h4 style="margin-bottom: 1rem; color: #FFC107;">
                                    <i class="fas fa-star"></i> COUVERTURES DISPONIBLES CORRESPONDANTES
                                </h4>
                                ${matchingBlankets.map(blanket => `
                                    <div class="blanket-match">
                                        <div class="blanket-color" style="background-color: ${blanket.color}; width: 16px; height: 16px;"></div>
                                        <div class="match-details">
                                            <strong>${blanket.name}</strong>
                                            <div style="font-size: 0.9rem; color: var(--netflix-light-gray);">
                                                ${blanket.weight > 0 ? `${blanket.weight}g/m²` : 'Chemise'} • 
                                                ${blanket.tempMin}°-${blanket.tempMax}°C •
                                                ${blanket.waterproof ? '💧' : ''}${blanket.breathable ? '🌬️' : ''}
                                            </div>
                                        </div>
                                        <div class="match-percentage">
                                            ${calculateMatchPercentage(temp, blanket.tempMin, blanket.tempMax)}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    recommendationHTML += `
                        <div class="info">
                            <i class="fas fa-info-circle" aria-hidden="true"></i> 
                            RECOMMANDATION POUR ${horseNameElements[0].textContent} (${isTondu ? 'TONDU' : 'NON TONDU'})
                        </div>
                    `;
                    
                    resultModalBody.innerHTML = recommendationHTML;
                    
                    openModal(resultModal);
                } else {
                    resultModalBody.innerHTML = `
                        <div class="temperature-display">${Math.round(temp)}°C</div>
                        <div class="recommendation">TEMPORATURE HORS PLAGE</div>
                        <div class="details">La température n'est pas couverte par nos recommandations.</div>
                        <div class="info"><i class="fas fa-info-circle" aria-hidden="true"></i> OUVREZ LE GUIDE POUR PLUS DE DÉTAILS.</div>
                    `;
                    openModal(resultModal);
                }
            }
            
            function findMatchingBlankets(temp) {
                return currentBlankets.filter(blanket => 
                    temp >= blanket.tempMin && temp <= blanket.tempMax
                ).sort((a, b) => {
                    const aCenter = (a.tempMin + a.tempMax) / 2;
                    const bCenter = (b.tempMin + b.tempMax) / 2;
                    const aDistance = Math.abs(temp - aCenter);
                    const bDistance = Math.abs(temp - bCenter);
                    return aDistance - bDistance;
                });
            }
            
            function calculateMatchPercentage(temp, min, max) {
                const range = max - min;
                const distanceFromCenter = Math.abs(temp - (min + max) / 2);
                const match = Math.max(0, 100 - (distanceFromCenter / range) * 200);
                return Math.round(match);
            }

            function openModal(modal) {
                lastFocusedElement = document.activeElement;
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('active');
                
                const closeBtn = modal.querySelector('.close-modal');
                if (closeBtn) closeBtn.focus();
            }

            function closeModal(modal) {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('active');
                
                if (lastFocusedElement) lastFocusedElement.focus();
            }

            // ==================== ÉVÉNEMENTS ====================

            // Événements météo
            useWeatherTempBtn.addEventListener('click', useWeatherTemperature);
            refreshWeatherBtn.addEventListener('click', loadWeather);

            // Événements localisation
            locationBadge.addEventListener('click', openCitySelector);

            locationBadge.addEventListener('mouseenter', function() {
                if (!this.classList.contains('loading') && !this.classList.contains('error')) {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 4px 15px rgba(229, 9, 20, 0.3)';
                    this.style.background = 'rgba(229, 9, 20, 0.3)';
                    this.style.borderColor = 'var(--netflix-red)';
                }
            });
            
            locationBadge.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = 'none';
                if (currentLocation.textContent === "Localisation GPS") {
                    this.style.background = "rgba(0, 168, 255, 0.2)";
                    this.style.borderColor = "rgba(0, 168, 255, 0.4)";
                    this.style.color = "var(--weather-blue)";
                } else if (currentLocation.textContent === "Erreur" || currentLocation.textContent === "Chargement...") {
                    // Ne rien changer pour les états d'erreur/chargement
                } else {
                    this.style.background = "rgba(0, 210, 211, 0.2)";
                    this.style.borderColor = "rgba(0, 210, 211, 0.4)";
                    this.style.color = "#00D2D3";
                }
            });

            locationAuto.addEventListener('change', function() {
                if (this.checked) {
                    currentLocationType = 'auto';
                    manualLocationSection.style.display = 'none';
                    loadWeather();
                }
            });

            locationManual.addEventListener('change', function() {
                if (this.checked) {
                    currentLocationType = 'manual';
                    manualLocationSection.style.display = 'block';
                    loadWeather();
                }
            });

            settingsCitySelect.addEventListener('change', function() {
                if (this.value) {
                    currentManualCity = this.value;
                    if (currentLocationType === 'manual') {
                        loadWeather();
                    }
                }
            });

            // Événements pour la sélection de ville
            cityCards.forEach(card => {
                card.addEventListener('click', function() {
                    const selectedCity = this.getAttribute('data-city');
                    selectCity(selectedCity);
                });
            });

            function openCitySelector() {
                openModal(cityModal);
            }

            function selectCity(cityName) {
                if (citiesDatabase[cityName]) {
                    currentManualCity = cityName;
                    currentLocationType = 'manual';
                    
                    locationManual.checked = true;
                    locationAuto.checked = false;
                    manualLocationSection.style.display = 'block';
                    settingsCitySelect.value = currentManualCity;
                    
                    loadWeather();
                    
                    saveLocationPreferences();
                    
                    closeModal(cityModal);
                }
            }

            closeCityBtn.addEventListener('click', () => {
                closeModal(cityModal);
            });

            cityModal.addEventListener('click', (e) => {
                if (e.target === cityModal) closeModal(cityModal);
            });

            // Événements existants
            temperatureInput.addEventListener('change', calculateRecommendation);

            settingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const horseName = document.getElementById('settings-horse-name').value;
                const ownerName = document.getElementById('settings-owner-name').value;
                isTondu = document.getElementById('settings-tondu-oui').checked;
                
                currentLocationType = document.querySelector('input[name="location-type"]:checked').value;
                if (currentLocationType === 'manual') {
                    currentManualCity = settingsCitySelect.value;
                }
                
                localStorage.setItem('horseName', horseName);
                localStorage.setItem('ownerName', ownerName);
                localStorage.setItem('isTondu', isTondu);
                saveLocationPreferences();
                
                updateHorseName(horseName);
                updateOwnerName(ownerName);
                updateTonteIndicator();
                
                loadWeather();
                
                closeModal(settingsModal);
            });

            openGuideBtn.addEventListener('click', () => {
                openModal(guideModal);
            });

            openSettingsBtn.addEventListener('click', () => {
                openModal(settingsModal);
            });

            closeResultBtn.addEventListener('click', () => {
                closeModal(resultModal);
            });

            closeGuideBtn.addEventListener('click', () => {
                closeModal(guideModal);
            });

            closeSettingsBtn.addEventListener('click', () => {
                closeModal(settingsModal);
            });

            clearHistoryBtn.addEventListener('click', clearHistory);
            toggleHistoryBtn.addEventListener('click', toggleHistory);

            resultModal.addEventListener('click', (e) => {
                if (e.target === resultModal) closeModal(resultModal);
            });

            guideModal.addEventListener('click', (e) => {
                if (e.target === guideModal) closeModal(guideModal);
            });

            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeModal(settingsModal);
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal(resultModal);
                    closeModal(guideModal);
                    closeModal(settingsModal);
                    closeModal(blanketsModal);
                    closeModal(cityModal);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' && document.querySelector('.modal-overlay.active')) {
                    const modal = document.querySelector('.modal-overlay.active');
                    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
            });

            // ==================== INITIALISATION ====================

            function initializeApp() {
                initializeSettings();
                initializeBlanketManagement();
                updateTonteIndicator();
            }

            initializeApp();
        });
    </script>
</body>
</html>